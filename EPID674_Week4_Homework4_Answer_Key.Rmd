---
title: "EPID674 Epidemiologic Data Analysis using R"
subtitle: "Homework 4 Answer Key"
author: "Kelly Bakulski"
date: "Last compiled on `r format(Sys.Date(), '%B %d, %Y')`"
output:
  word_document: default
---

# Setup libraries and dataset
```{r setup}
knitr::opts_chunk$set(echo = TRUE)

library(foreign)
library(epiDisplay)
library(stats)
library(Hmisc)
library(gmodels)

#directory <- "/cloud/project/"
directory <- "~/Google Drive File Stream/My Drive/Teaching/EPID674/2020_fall/EPID674_Week4_Class/"
load(paste0(directory, "bpa.rda"))
```

## Using the dataset “bpa.rda”, answer the following:

# Problem 1. 
## Does urinary BPA differ by age group (20-39, 40-59, 60+)?

```{r problem 1}
## Age group
age3<-cut(bpa$age, breaks=c(20,39,59,90), include.lowest=T)
summary(age3)

#check normality of ubpa
hist(bpa$ubpa) #UPBA variable is highly right skewed. Need to log transform UBPA or perform non-parametric test.
hist(log(bpa$ubpa))

tapply(log(bpa$ubpa), age3, mean) #set expectation
anova(lm(log(bpa$ubpa)~age3))
kruskal.test(bpa$ubpa~age3)
summary(lm(log(bpa$ubpa)~age3))

## To check linear trend, the factor variable age3 should be converted to a numeric variable
age3n<-unclass(age3)
tapply(log(bpa$ubpa), age3n, mean) #set expectation
summary(lm(log(bpa$ubpa)~age3n))
```
# Yes, urinary bpa levels differ by age group. Levels are higher in lower ages. 

# Problem 2
## Does urinary BPA differ by geneder?

```{r problem 2}
tapply(log(bpa$ubpa), bpa$gender, mean) #set expectation
t.test(log(bpa$ubpa)~bpa$gender) #perform parametric test
t.test(log(bpa$ubpa)~bpa$gender, var.equal=T) #another option
wilcox.test(bpa$ubpa~bpa$gender) #non-parametric option
```
# Yes, urinary bpa levels differ by gender. They are higher in gender 1  and lower in gender 2.

# Problem 3
## Does urinary BPA differ by smoking status?

```{r problem 3}
#watch out for NaN. Need to recode as missing
table(bpa$SMK, useNA = "always")
bpa$SMK[is.nan(bpa$SMK)]<-NA #Assign value of NA to any entries that are non at number "NaN"
table(bpa$SMK, useNA = "always")

tapply(log(bpa$ubpa), bpa$SMK, mean) #Set expectation
kruskal.test(bpa$ubpa~bpa$SMK)
pairwise.t.test(log(bpa$ubpa),bpa$SMK)
anova(lm(log(bpa$ubpa)~factor(bpa$SMK)))
summary(lm(log(bpa$ubpa)~factor(bpa$SMK)))
```
# Yes, urinary BPA differs by smoking status. The biggest difference is between smoking group 1 and smoking group 2. 

# Problem 4
## T2DM can be defined as hemoglobin A1c ≥ 6.5% OR use of diabetes medication. Note: participants with high A1c and taking medication should also be considered T2DM cases.
## First, create a binary variable for T2DM using a1c and dmmed. How many T2DM cases are in each quartile of urinary BPA?

```{r problem 4 variable set up}
## we already created this in the previous exercise
bpa$t2dm<-ifelse(bpa$a1c>=6.5|bpa$dmmed==1, 1, 0)
tab1(bpa$t2dm)
ubpa4<-cut2(bpa$ubpa, g=4)
tab1(ubpa4)
table(ubpa4, bpa$t2dm)
# or
ubpa4<-cut(bpa$ubpa, quantile(bpa$ubpa, c(0,0.25,0.5,0.75,1)), include.lowest=T)
summary(ubpa4)
tapply(ubpa4, bpa$t2dm, summary)
```
# There are 154 T2DM cases in the lowest quartile of urinary bpa, 152 cases in the second quartile, 142 cases in the thir quartile, and 144 cases in the highest quartile.



##Compute the odds ratios of T2DM for each of the upper three quartiles of urinary BPA, as compared with the lowest quartile of urinary BPA.
```{r problem 4 calculations}
tabpct(bpa$t2dm,ubpa4)
chisq.test(bpa$t2dm,ubpa4)

cc(bpa$t2dm,ubpa4)
```
# There is no linear trend across the urinary BPA quartiles as shown in the plot above. The prevalence of T2DM is NOT associated with urinary BPA.
